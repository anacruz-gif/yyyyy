<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MPU6050 Dashboard Tiempo Real</title>

  <!-- Firebase v9 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    let app, database, chart;
    let labels = [];
    let dataMag = [];

    window.connectFirebase = function () {
      const apiKey = document.getElementById("apiKey").value;
      const dbURL = document.getElementById("dbURL").value;

      if (!apiKey || !dbURL) {
        alert("Ingrese API Key y Database URL");
        return;
      }

      const firebaseConfig = {
        apiKey: apiKey,
        databaseURL: dbURL
      };

      app = initializeApp(firebaseConfig);
      database = getDatabase(app);

      document.getElementById("login").style.display = "none";
      document.getElementById("dashboard").style.display = "block";

      initChart();
      listenData();
    }

    function initChart() {
      const ctx = document.getElementById("chart").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Magnitud de AceleraciÃ³n",
            data: dataMag,
            borderWidth: 2,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function listenData() {
      const mpuRef = ref(database, "mpu6050");

      onValue(mpuRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        const time = new Date().toLocaleTimeString();

        if (labels.length > 30) {
          labels.shift();
          dataMag.shift();
        }

        labels.push(time);
        dataMag.push(data.Magnitud);

        document.getElementById("ax").innerText = data.AccX.toFixed(3);
        document.getElementById("ay").innerText = data.AccY.toFixed(3);
        document.getElementById("az").innerText = data.AccZ.toFixed(3);

        chart.update();
      });
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: #0f172a;
      color: white;
      font-family: Arial;
      text-align: center;
    }

    input, button {
      padding: 10px;
      margin: 6px;
      width: 300px;
      border-radius: 6px;
      border: none;
    }

    button {
      background: #38bdf8;
      font-weight: bold;
      cursor: pointer;
    }

    .hidden {
      display: none;
    }

    .values {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 20px;
    }

    .box {
      background: #1e293b;
      padding: 15px;
      border-radius: 10px;
      width: 150px;
    }

    canvas {
      max-width: 850px;
      margin: 30px auto;
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="login">
    <h1>ðŸ”‘ Conectar a Firebase</h1>
    <input id="apiKey" placeholder="Firebase API Key">
    <input id="dbURL" placeholder="Firebase Database URL">
    <br>
    <button onclick="connectFirebase()">Conectar</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden">
    <h1>ðŸ“ˆ MPU6050 â€“ Tiempo Real</h1>

    <div class="values">
      <div class="box">AccX<br><b id="ax">0</b></div>
      <div class="box">AccY<br><b id="ay">0</b></div>
      <div class="box">AccZ<br><b id="az">0</b></div>
    </div>

    <canvas id="chart"></canvas>
  </div>

</body>
</html>
